---
title: "Swiss Participation in Horizon 2020"
author: "João Martins"
output: 
  html_document: 
    theme: cerulean
    code_folding: hide
    toc: true
    toc_float: true
    self_contained: false
editor_options: 
  chunk_output_type: console
---

```{r boilerplate, message=FALSE, warning=FALSE}
# source code: https://github.com/zambujo/swissparticipation
library(tidyverse)
library(vroom)
library(janitor)
library(lubridate)
library(here)
library(yaml)
library(glue)
library(scales)
library(ggsci)
library(ggrepel)
library(ggtext)
library(reactable)
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
source(here("R", "utils.R"))
```

<!-- badges: start -->
[![](https://img.shields.io/github/watchers/zambujo/swissparticipation?style=social)](https://github.com/zambujo/swissparticipation)
[![](https://img.shields.io/github/issues/zambujo/swissparticipation)](https://github.com/zambujo/swissparticipation/issues)
<!-- badges: end -->

> Pease find related statistics on the SERI's page: [Facts and Figures on the Swiss Participation in the EU-Framework Programmes for Research and Innovation](https://www.sbfi.admin.ch/sbfi/en/home/research-and-innovation/international-cooperation-r-and-i/eu-framework-programmes-for-research/f-f-swiss-participation.html).

## Data

Source: [**Horizon 2020 Dashboard data**](https://webgate.ec.europa.eu/dashboard/single/?appid=93297a69-09fd-4ef5-889f-b83c4e21d33e&sheet=c616ed33-064c-40c0-803a-e75045b78c05), last updated on 2021-12-06 (see [Annex: Raw Data](#raw-data)).

```{r read-dashboard-data}
df_schema <- here("data", "schema-cordis-plus.yml") %>%
  read_yaml() %>%
  as.list()

df_raw <-
  list.files(here("data"), pattern = "cordis-plus-", full.names = TRUE) %>%
  vroom(delim = ",", col_types = df_schema)
  # map_df(read_csv2, col_types = df_schema)

df_raw <- df_raw %>%
  mutate(
    pillar = fct_inseq(pillar),
    pillar = fct_rev(pillar),
    pillar = fct_relevel(pillar, "Cross-theme", after = 0),
    pillar = fct_recode(
      pillar, I = "1", II = "2", III = "3", IV = "4", V = "5"),
    org_type = fct_collapse(
      legal_entity_type,
      `Research & Education` = c("HES", "REC"),
      `Others (Excl. R&Ed)` = c("PRC", "PUB", "OTH")))

df <- df_raw %>%
  filter(framework_programme == "H2020") %>%
  filter(legal_name != "EUROPEAN ORGANIZATION FOR NUCLEAR RESEARCH")
```

## Total EU Contribution by Pillar: All Countries

```{r overview-pillar, eval=FALSE}
ggp <- df %>%
  mutate(
    pillar = fct_other(pillar, keep = chr(roman(1:5))),
    pillar = fct_relevel(pillar, "Other", after = 0)
  ) %>%
  filter(!is.na(pillar)) %>%
  group_by(pillar) %>%
  summarise(size_pillar = sum(eu_contribution)) %>%
  mutate(
    share = 100 * prop.table(size_pillar),
    fp = "H2020"
  ) %>%
  ggplot(aes(x = fp, y = size_pillar, fill = pillar)) +
  geom_col(position = position_stack()) +
  geom_text(
    aes(label = sprintf("%.1f%%", share)),
    position = position_stack(vjust = 0.5),
    size = 4,
    fontface = "bold"
  ) +
  coord_flip() +
  scale_fill_nejm(alpha = .5, guide = guide_legend(reverse = TRUE)) +
  theme_minimal(base_size = 14) +
  labs(x = NULL, y = NULL) +
  theme(
    legend.position = "bottom",
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank()
  )

ggsave("budget-allocation.svg",
  plot = ggp,
  w = 12,
  h = 3
)
```

![](https://raw.githubusercontent.com/zambujo/swissparticipation/main/data/budget-allocation.svg "Total EU contribution to the different pillars in H2020.")

## Top Participating Countries

Participation count, number of projects (distinct), and total EU contribution for the top 10 participating countries (by total EU contribution).

```{r top-participants}
# find and sort top participants
top_participants <- df %>%
  group_by(Country = country) %>%
  summarise(contrib_country = sum(eu_contribution, na.rm = TRUE)) %>%
  ungroup() %>%
  arrange(desc(contrib_country))

ch_rank <- which(pull(top_participants, Country) == "Switzerland")

# calculate further participation statistics
country_participation <- df %>%
  group_by(
    Country = country,
    `Call Year` = call_year,
    Type = org_type
  ) %>%
  summarise(
    `Participation Count` = n(),
    `Nb Projects` = n_distinct(project_id),
    `EU Contribution` = sum(eu_contribution, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  arrange(`Type`, `Call Year`)

# show with reactable
top_participants %>%
  select(Country) %>%
  head(10) %>%
  inner_join(country_participation, by = "Country") %>%
  reactable(
    groupBy = c("Country", "Call Year"),
    columns = list(
      `Participation Count` = colDef(
        aggregate = "sum",
        format = colFormat(separators = TRUE)
      ),
      `Nb Projects` = colDef(
        aggregate = "sum",
        format = colFormat(separators = TRUE)
      ),
      `EU Contribution` = colDef(
        aggregate = "sum",
        format = colFormat(
          currency = "EUR",
          separators = TRUE,
          digits = 2
        )
      )
    ),
    highlight = TRUE,
    compact = TRUE
  )
```

Switzerland ranks `r ch_rank`th by total EU contribution in H2020 (the CERN is not taken into account, see [Annex: CERN](#cern)).

```{r visual-countries, fig.asp=.5}
# minimal plotting
pal <- c(
  rep("#DFD8CA", ch_rank - 1),
  "#B91646",
  rep("#DFD8CA", 10 - ch_rank)) %>%
  rev()

top_participants %>%
  mutate(
    Country = fct_rev(fct_inorder(Country)),
    share = 100 * prop.table(contrib_country)
  ) %>%
  head(10) %>%
  ggplot(aes(x = contrib_country, y = Country, fill = Country)) +
  geom_col() +
  geom_text(
    aes(label = sprintf("%.1f%%", share)),
    hjust = 1.15,
    size = 4,
    fontface = "bold",
    family = "Gill Sans"
  ) +
  labs(x = NULL, y = NULL) +
  scale_fill_manual(values = pal, guide = "none") +
  theme_void() +
  theme(
    plot.margin = margin(c(4, 2, 4, 8)),
    axis.text.y = element_text(
      margin = margin(t = 0, r = -10, b = 0, l = 5),
      size = 14,
      family = "Gill Sans",
      hjust = 1,
      color = "gray10"
    )
  )
```


## Swiss Participation: An Overview

```{r get-participation}
get_participation <- function(x) {
  x %>%
    filter(!is.na(pillar)) %>%
    mutate(pillar = fct_rev(pillar)) %>%
    group_by(
      Pillar = pillar,
      Priority = thematic_priority_abbr,
      `Call Year` = call_year
    ) %>%
    summarise(
      `Participation Count` = n(),
      `Nb Projects` = n_distinct(project_id),
      `EU Contribution` = sum(eu_contribution, na.rm = TRUE)
    ) %>%
    ungroup() %>%
    mutate(`EU Contribution` = round(`EU Contribution`, 1)) %>%
    reactable(
      groupBy = c("Pillar", "Priority"),
      columns = list(
        Pillar = colDef(footer = "Total"),
        `Participation Count` = colDef(
          aggregate = "sum",
          format = colFormat(separators = TRUE),
          footer = function(values) {
            sum(values) %>% format(big.mark = ",")
          }
        ),
        `Nb Projects` = colDef(
          aggregate = "sum",
          format = colFormat(separators = TRUE),
          footer = function(values) {
            sum(values) %>% format(big.mark = ",")
          }
        ),
        `EU Contribution` = colDef(
          aggregate = "sum",
          format = colFormat(
            currency = "EUR",
            separators = TRUE,
            digits = 2
          ),
          footer = function(values) {
            sum(values) %>%
              format(big.mark = ",") %>%
              str_c("€", .)
          }
        )
      ),
      defaultColDef = colDef(footerStyle = list(fontWeight = "bold")),
      highlight = TRUE,
      compact = TRUE
    )
}
```

Swiss participation in H2020: participation count, number of projects (distinct), total EU contribution by pillar, thematic priority, and call year.

```{r overview}
df %>%
  filter(country_code == "CH") %>%
  get_participation()
```

```{r visual-overview, eval=FALSE}
# Differentiate pillars 1 to III
stats_depth_1 <- df %>%
  filter(!is.na(pillar)) %>%
  filter(country_code == "CH") %>%
  filter(!pillar %in% chr(roman(1:3))) %>%
  mutate(pillar = fct_rev(pillar)) %>%
  group_by(pillar, pillar_descr) %>%
  summarise(total_eu_contrib = sum(eu_contribution)) %>%
  ungroup() %>%
  # for printing
  mutate(
    pillar_descr = ifelse(
      chr(pillar) %in% chr(roman(4:5)),
      str_c(pillar, ". ", pillar_descr),
      chr(pillar)
    ),
    thematic_priority_abbr = NA
  ) %>%
  # for binding
  select(
    pillar = pillar_descr,
    thematic_priority = thematic_priority_abbr,
    contrib = total_eu_contrib
  )

stats_depth_2 <- df %>%
  filter(!is.na(pillar)) %>%
  filter(country_code == "CH") %>%
  filter(pillar %in% chr(roman(1:3))) %>%
  mutate(pillar = fct_rev(pillar)) %>%
  group_by(pillar, pillar_descr, thematic_priority_abbr) %>%
  summarise(total_eu_contrib = sum(eu_contribution)) %>%
  ungroup() %>%
  # for printing
  unite("pillar", starts_with("pillar"), sep = ". ") %>%
  # for binding
  select(pillar,
    thematic_priority = thematic_priority_abbr,
    contrib = total_eu_contrib
  )

stats_depth_2 %>%
  bind_rows(stats_depth_1) %>%
  mutate(
    thematic_priority = replace_na(thematic_priority, ""),
    contrib_txt = contrib / 1000000,
    contrib_txt = format(
      contrib_txt,
      big.mark = ",",
      decimal.mark = ".",
      trim = TRUE,
      digits = 2
    ),
    contrib_txt = str_c("M€", contrib_txt)
  ) %>%
  write_csv(here("data", "h2020-treemap.csv"))
# plot with https://rawgraphs.io
```

Treemap showing the overall H2020 EU contribution (MEUR) to Switzerland by Pillar and Thematic Priority. Only the three largest pillars are shown.

![](https://raw.githubusercontent.com/zambujo/swissparticipation/main/data/treemap-ch.svg "H2020 EU contribution to Swiss participants, by pillar and thematic priority.")

### Swiss Participation by Sector

```{r ch-type-role, fig.asp=.7}
pal <- c("#B91646", "#DFD8CA") %>%
  rev()

df %>%
  filter(!is.na(pillar)) %>%
  filter(country_code == "CH") %>%
  mutate(
    pillar = fct_other(pillar, keep = chr(roman(1:5))),
    pillar = fct_relevel(pillar, "Other", after = 0)
  ) %>%
  group_by(pillar, org_type, role = partner_role) %>%
  summarise(contrib = sum(eu_contribution, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(org_type = fct_rev(org_type)) %>%
  arrange(pillar, org_type) %>%
  ggplot(aes(x = pillar, y = contrib, fill = org_type)) +
  geom_col(position = position_stack(reverse = FALSE)) +
  scale_fill_manual(values = pal, guide = guide_legend(reverse = TRUE)) +
  scale_y_continuous(labels = unit_format(
    suffix = "",
    scale = 1e-6,
    big.mark = ","
  )) +
  coord_flip() +
  facet_wrap(role ~ ., ncol = 1) +
  theme_minimal() +
  labs(
    title = "Distribution of EU Contribution to Swiss Institutions",
    subtitle = "By Pillar, Institution Sector, and Instituion Role",
    x = "Pillar",
    y = "EU Contribution to Swiss Institutions (MioEUR)"
  ) +
  theme(
    text = element_text(size = 15, family = "Gill Sans", color = "gray10"),
    plot.title.position = "plot",
    legend.position = "top",
    legend.title = element_blank(),
    axis.title.y = element_text(angle = 0, vjust = 1.05, margin = margin(r = -30))
  )
```

#### EU Contribution to Swiss Institutions in Research and HigherEd

```{r overview-in-research}
df %>%
  filter(country_code == "CH") %>%
  filter(org_type == "Research & Education") %>%
  get_participation()
```

---

## Annex

### Typology of the Top-10 Participating Countries

```{r additional-context, fig.asp=1}
pal <- c(
  rep("#DFD8CA", ch_rank - 1),
  "#B91646",
  rep("#DFD8CA", 10 - ch_rank)
) %>%
  rev()

## share to Pillar I
contribution_share_pillar <- df %>%
  filter(!is.na(pillar)) %>%
  # excluding Switzerland in 2014
  filter(country_code != "CH" | call_year != 2014) %>%
  semi_join(top_participants %>%
    select(country = Country) %>%
    head(10),
  by = "country"
  ) %>%
  group_by(
    Country = country,
    Pillar = pillar
  ) %>%
  summarise(`Contribution` = sum(eu_contribution)) %>%
  mutate(share_pillar = 100 * prop.table(Contribution)) %>%
  filter(Pillar == "I") %>%
  select(-Pillar, -Contribution)

## share to Resesearch and HigherEd
contribution_share_reshed <- df %>%
  filter(!is.na(pillar)) %>%
  # excluding Switzerland in 2014
  filter(country_code != "CH" | call_year != 2014) %>%
  semi_join(top_participants %>%
    select(country = Country) %>%
    head(10),
  by = "country"
  ) %>%
  group_by(
    Country = country,
    Type = org_type
  ) %>%
  summarise(`Contribution` = sum(eu_contribution)) %>%
  mutate(share_reshed = 100 * prop.table(Contribution)) %>%
  filter(Type == "Research & Education") %>%
  select(-Type, -Contribution)

top_participants %>%
  inner_join(contribution_share_reshed, by = c("Country")) %>%
  inner_join(contribution_share_pillar, by = c("Country")) %>%
  mutate(
    Country = fct_rev(fct_inorder(Country)),
    contrib_country = contrib_country / 1000000
  ) %>%
  ggplot(
    aes(
      x = share_pillar,
      y = share_reshed,
      label = Country,
      col = Country,
      size = contrib_country
    )
  ) +
  geom_point(fill = NA) +
  geom_text_repel(
    size = 5,
    show.legend = FALSE,
    box.padding = .75,
    family = "Gill Sans"
  ) +
  guides(size = guide_legend(
    title = "Total EU Contribution (MioEUR) :",
    override.aes = list(fill = "gray45", col = "gray45", shape = 21)
  )) +
  labs(
    x = "Contributions to Pillar I: Excellent Science (%)",
    y = "Contribution to Institutions in Research and HigherEd (%)"
  ) +
  scale_color_manual(values = pal, guide = "none") +
  theme_minimal() +
  theme(
    text = element_text(size = 16, family = "Gill Sans", color = "gray10"),
    plot.title.position = "plot",
    legend.position = "top"
  )
```

### Relative Semester Distribution of EU Contribution

```{r, time-distribution, fig.asp=.6}
pal <- c("#B91646", "#DFD8CA")

ch <- df %>%
  filter(!is.na(call_deadline_date)) %>%
  filter(!is.na(org_type)) %>%
  filter(country_code == "CH") %>%
  mutate(
    call_semester = floor_date(call_deadline_date, "6 months")) %>%
  group_by(Country = country, org_type, Semester = call_semester) %>%
  summarise(contrib = sum(eu_contribution, na.rm = TRUE)) %>%
  mutate(Share = 100 * prop.table(contrib)) %>%
  select(-contrib)

rest <- df %>%
  filter(!is.na(call_deadline_date)) %>%
  filter(!is.na(org_type)) %>%
  filter(!country_code %in% c("CH")) %>%
  mutate(
    call_semester = floor_date(call_deadline_date, "6 months")) %>%
  group_by(org_type, Semester = call_semester) %>%
  summarise(contrib = sum(eu_contribution)) %>%
  mutate(Share = 100 * prop.table(contrib)) %>%
  select(-contrib) %>%
  mutate(Country = "Remaining Countries") %>%
  relocate(Country)

ch %>%
  bind_rows(rest) %>%
  mutate(Country = factor(
    Country,
    levels = c("Switzerland", "Remaining")
  )) %>%
  ggplot(aes(x = Semester, y = Share, fill = Country)) +
  geom_bar(stat = "identity", width = 120, position = position_dodge(width = 128)) +
  labs(
    title = "Time Distribution of EU Contribution by Institution Sector",
    subtitle = glue(
      "<span style='color:{pal[1]};'>Switzerland</span> ",
      "vs <span style='color:{pal[2]};'>Remaining Countries</span>"
    ),
    x = "Call Semester",
    y = "%"
  ) +
  scale_fill_manual(values = pal, guide = "none") +
  facet_wrap(org_type ~ ., ncol = 1, scales = "free_y") +
  theme_minimal() +
  theme(
    plot.title.position = "plot",
    plot.subtitle = element_markdown(),
    text = element_text(
      size = 13,
      family = "Gill Sans",
      color = "gray10"
    )
  )
```

### Top Recipients in Switzerland

#### Top 30 in Research and Higher Education

```{r}
df %>%
  filter(country_code == "CH") %>%
  filter(org_type == "Research & Education") %>%
  group_by(Institution = legal_name) %>%
  summarise(
    `Nb Projects` = n_distinct(project_id),
    `EU Contribution` = sum(eu_contribution, na.rm = TRUE)
  ) %>%
  arrange(desc(`EU Contribution`)) %>%
  mutate(Institution = str_to_title(Institution)) %>%
  slice_head(n = 30) %>%
  reactable(
    columns = list(
      `Nb Projects` = colDef(sortable = TRUE),
      `EU Contribution` = colDef(
        sortable = TRUE,
        format = colFormat(
          currency = "EUR",
          separators = TRUE,
          digits = 2
        )
      )
    ),
    highlight = TRUE,
    searchable = TRUE,
    sortable = FALSE,
    showSortable = TRUE,
    compact = TRUE,
    minRows = 10
  )
```

#### Top 30 not in Research and Higher Education

```{r}
df %>%
  filter(country_code == "CH") %>%
  # remove international organisations
  filter(org_type == "Others (Excl. R&Ed)") %>%
  group_by(Institution = legal_name) %>%
  summarise(
    `Nb Projects` = n_distinct(project_id),
    `EU Contribution` = sum(eu_contribution, na.rm = TRUE)
  ) %>%
  arrange(desc(`EU Contribution`)) %>%
  mutate(Institution = str_to_title(Institution)) %>%
  slice_head(n = 30) %>%
  reactable(
    columns = list(
      `Nb Projects` = colDef(sortable = TRUE),
      `EU Contribution` = colDef(
        sortable = TRUE,
        format = colFormat(
          currency = "EUR",
          separators = TRUE,
          digits = 2
        )
      )
    ),
    highlight = TRUE,
    searchable = TRUE,
    sortable = FALSE,
    showSortable = TRUE,
    compact = TRUE,
    minRows = 10
  )
```


### CERN

```{r cern-total}
total_cern <- df_raw %>%
  filter(country_code == "CH") %>%
  filter(legal_name == "EUROPEAN ORGANIZATION FOR NUCLEAR RESEARCH") %>%
  summarise(total_eu_contrib = sum(eu_contribution, na.rm = TRUE)) %>%
  pull() %>%
  format(big.mark = ",", decimal.mark = ".", trim = TRUE, digits = 11)
```

**Note**: EU Contribution to Switzerland include `r str_c("€", total_cern)` awarded to the CERN.  Please find the EU contribution to CERN in detail below:

```{r cern-detail}
df_raw %>%
  filter(country_code == "CH") %>%
  filter(legal_name == "EUROPEAN ORGANIZATION FOR NUCLEAR RESEARCH") %>%
  get_participation()
```

### Raw Data

The raw data set contains `r nrow(df) %>% format(big.mark = ",")` rows with the following attributes:

```{r}
df_raw %>%
  sample_n(100) %>%
  glimpse()
```

