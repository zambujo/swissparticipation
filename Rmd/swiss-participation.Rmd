---
title: "ðŸš§ Swiss Participation in EU Framework Programmes ðŸš§"
output: 
  html_document: 
    theme: cerulean
    code_folding: hide
    toc: true
    toc_float: true
    self_contained: false
editor_options: 
  chunk_output_type: console
---

```{r boilerplate, message=FALSE}
# source code: https://github.com/zambujo/swissparticipation
library(tidyverse)
library(ggsci)
library(scales)
library(readxl)
library(here)
library(janitor)
library(reactable)
knitr::opts_chunk$set(message = FALSE)
```

[![](https://img.shields.io/github/watchers/zambujo/swissparticipation?style=social)](https://github.com/zambujo/swissparticipation)
[![](https://img.shields.io/github/issues/zambujo/swissparticipation)](https://github.com/zambujo/swissparticipation/issues)

> Pease find more detailed figures at [Facts and Figures on the Swiss Participation in the EU-Framework Programmes for Research and Innovation](https://www.sbfi.admin.ch/sbfi/en/home/research-and-innovation/international-cooperation-r-and-i/eu-framework-programmes-for-research/f-f-swiss-participation.html).

## Data

The [**Horizon 2020 Dashboard**](https://webgate.ec.europa.eu/dashboard/single/?appid=93297a69-09fd-4ef5-889f-b83c4e21d33e&sheet=c616ed33-064c-40c0-803a-e75045b78c05) project data was last updated on 2021-12-06 (see also: [Annex](#annex)).

```{r read-dashboard-data}
df <-
  here("data-raw", "horizon2020.xlsx") %>%
  read_excel() %>%
  clean_names()

# minimal cleaning ----
df <- df %>%
  mutate(
    # rename pillars
    pillar_abbr = str_replace(pillar_abbr, fixed("EU.0."), "Cross-theme"),
    pillar_abbr = str_replace(pillar_abbr, fixed("EU.1."), "1"),
    pillar_abbr = str_replace(pillar_abbr, fixed("EU.2."), "2"),
    pillar_abbr = str_replace(pillar_abbr, fixed("EU.3."), "3"),
    pillar_abbr = str_replace(pillar_abbr, fixed("EU.4."), "4"),
    pillar_abbr = str_replace(pillar_abbr, fixed("EU.5."), "5"),
    # import EU contribution
    eu_contribution = str_replace(eu_contribution, fixed("-"), "0"),
    eu_contribution = as.numeric(eu_contribution),
    # import dates
    signature_date = as.Date(signature_date, format = "%d/%m/%Y"),
    call_deadline_date = as.Date(call_deadline_date, format = "%d/%m/%Y"),
    project_start_date = as.Date(project_start_date, format = "%d/%m/%Y"),
    project_end_date = as.Date(project_end_date, format = "%d/%m/%Y"),
    signature_year = str_sub(signature_date, 1, 4),
    call_year = str_sub(call_deadline_date, 1, 4),
    signature_year = as.integer(signature_year),
    call_year = as.integer(call_year)
  )
```

## Contribution by Pillar

```{r overview-pillar, eval=FALSE}
ggp <- df %>%
  mutate(
    pillar_abbr = str_replace(pillar_abbr, fixed("Cross-theme"), "Other"),
    pillar_abbr = str_replace(pillar_abbr, fixed("Euratom"), "Other"),
  ) %>%
  group_by(
    Pillar = pillar_abbr, 
  ) %>%
  summarise(
    `Participation Count` = n(),
    `Nb Projects` = n_distinct(project_nbr),
    `EU Contribution` = sum(eu_contribution, na.rm = TRUE)) %>%
  mutate(
    `EU Contribution Share` = 100 * prop.table(`EU Contribution`),
    `EU Contribution` = round(`EU Contribution`, 1),
    `EU Contribution Share` = round(`EU Contribution Share`, 1),
    FP = "H2020"
  ) %>%
  ggplot(aes(
    x = FP,
    y = `EU Contribution Share`,
    fill = Pillar
  )) +
  geom_col(position = position_stack(reverse = TRUE)) +
  geom_text(
    aes(label = paste0(`EU Contribution Share`, "%")),
    position = position_stack(vjust = 0.5, reverse = TRUE),
    size = 4, fontface = "bold"
  ) +
  coord_flip() + 
  scale_fill_nejm() +
  theme_minimal(base_size = 14) +
  ylab(NULL) +
  xlab(NULL) +
  theme(
    legend.position = "bottom", 
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank()
  )
ggsave(file="budget-allocation.svg", plot=ggp, width=12, height=6)
```

![](https://raw.githubusercontent.com/zambujo/swissparticipation/main/data/budget-allocation.svg "Total EU contribution to the different pillars in H2020.")

## Top countries

Participation count, number of projects (distinct), and total EU contribution for the top 10 participating countries (by total EU contribution).

```{r top-countries}
top10 <- df %>%
  group_by(Country = country) %>%
  summarise(
    `EU Contribution` = sum(eu_contribution, na.rm = TRUE)) %>%
  ungroup() %>%
  arrange(desc(`EU Contribution`)) %>%
  select(Country) %>%
  head(10)

country_participation <- df %>%
  group_by(
    Country = country,
    `Call Year` = call_year,
    Type = legal_entity_type_descr) %>%
  summarise(
    `Participation Count` = n(),
    `Nb Projects` = n_distinct(project_nbr),
    `EU Contribution` = sum(eu_contribution, na.rm = TRUE)) %>%
  ungroup() %>%
  arrange(`Type`, `Call Year`)
  
top10 %>%
  inner_join(country_participation, by = "Country") %>%
  reactable(
    groupBy = c("Country", "Call Year"),
    columns = list(
      `Participation Count` = colDef(
        aggregate = "sum",
        format = colFormat(separators = TRUE)),
      `Nb Projects` = colDef(
        aggregate = "sum", 
        format = colFormat(separators = TRUE)),
      `EU Contribution` = colDef(
        aggregate = "sum",
        format = colFormat(currency = "EUR", separators = TRUE, digits = 2))
    ),
    highlight = TRUE,
    compact = TRUE
  )
```

### Visual Summary

```{r visual-countries}
df %>%
  group_by(Country = country) %>%
  summarise(
    `EU Contribution` = sum(eu_contribution, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(Country = fct_lump(Country, 10, w = `EU Contribution`)) %>%
  group_by(Country) %>%
  summarise(
    `EU Contribution` = sum(`EU Contribution`, na.rm = TRUE)) %>%
  ungroup() %>%
  arrange(desc(`EU Contribution`)) %>%
  mutate(
    contrib_txt = format(
      `EU Contribution`,
      big.mark = ",",
      decimal.mark = ".",
      trim = TRUE,
      digits = 12),
    contrib_txt = str_c("â‚¬", contrib_txt)) %>%
    write_csv(here("data", "h2020-countries-treemap.csv"))
```

A treemap showing the total EU contribution to the top 10 participating countries in H2020.  Switzerland ranks 8th by total EU contribution.

![](https://raw.githubusercontent.com/zambujo/swissparticipation/main/data/treemap-countries.svg "Total EU contribution to the top 10 countries participating in H2020.")

## Swiss participation: an overview

Swiss participation in H2020: participation count, number of projects (distinct), total EU contribution by pillar, thematic priority, and call year.

```{r overview}
df %>%
  filter(country_code == "CH") %>%
  group_by(
    Pillar = pillar_abbr, 
    Priority = thematic_priority_abbr, 
    `Call Year` = call_year) %>%
  summarise(
    `Participation Count` = n(),
    `Nb Projects` = n_distinct(project_nbr),
    `EU Contribution` = sum(eu_contribution, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(
    `EU Contribution` = round(`EU Contribution`, 1)
  ) %>%
  reactable(
    groupBy = c("Pillar", "Priority"),
    columns = list(
      `Participation Count` = colDef(
        aggregate = "sum", 
        format = colFormat(separators = TRUE)),
      `Nb Projects` = colDef(
        aggregate = "sum", 
        format = colFormat(separators = TRUE)),
      `EU Contribution` = colDef(
        aggregate = "sum",
        format = colFormat(currency = "EUR", separators = TRUE, digits = 2))
    ),
    highlight = TRUE,
    compact = TRUE
  )
```


### Visual summary

```{r visual-overview}
stats_depth_1 <-
  df %>%
  filter(country_code == "CH") %>%
  filter(!pillar_abbr %in% c("I", "II", "III")) %>%
  group_by(pillar_abbr, pillar_descr) %>%
  summarise(total_eu_contrib = sum(eu_contribution, na.rm = TRUE)) %>%
  ungroup() %>%
  unite("pillar", starts_with("pillar"), sep = ". ") %>%
  mutate(
    pillar = str_replace(pillar,
                         fixed("Cross-theme. Cross-theme"),
                         "Cross-theme"),
    pillar = str_replace(
      pillar,
      fixed("Euratom. Euratom Research and Training Programme"),
      "Euratom"
    ),
    thematic_priority_abbr = NA
  ) %>%
  select(pillar,
         thematic_priority = thematic_priority_abbr,
         contrib = total_eu_contrib)

stats_depth_2 <- df %>%
  filter(country_code == "CH") %>%
  filter(pillar_abbr %in% c("I", "II", "III")) %>%
  # simple stats
  group_by(pillar_abbr, pillar_descr, thematic_priority_abbr) %>%
  summarise(total_eu_contrib = sum(eu_contribution, na.rm = TRUE)) %>%
  ungroup() %>%
  # for printing
  unite("pillar", starts_with("pillar"), sep = ". ") %>%
  select(pillar,
         thematic_priority = thematic_priority_abbr,
         contrib = total_eu_contrib)

# for treemap with https://rawgraphs.io
stats_depth_1 %>%
  bind_rows(stats_depth_2) %>%
  arrange(pillar, desc(contrib)) %>%
  mutate(
    thematic_priority = replace_na(thematic_priority, ""),
    contrib_txt = contrib / 1000000,
    contrib_txt = format(
      contrib_txt,
      big.mark = ",",
      decimal.mark = ".",
      trim = TRUE,
      digits = 2),
    contrib_txt = str_c("Mâ‚¬", contrib_txt)) %>%
  write_csv(here("data", "h2020-treemap.csv"))
```

A treemap showing the overall H2020 EU contribution (MEUR) to Switzerland by Pillar and Thematic Priority. Only the three largest pillars are shown.

![](https://raw.githubusercontent.com/zambujo/swissparticipation/main/data/treemap-ch.svg "H2020 EU contribution to Swiss participants, by pillar and thematic priority.")

#### EU Contribution to CH by organisation type

```{r ch-type}
df %>%
  filter(country_code == "CH") %>%
  mutate(
    pillar_abbr = str_replace(pillar_abbr, fixed("Cross-theme"), "Other"),
    pillar_abbr = str_replace(pillar_abbr, fixed("Euratom"), "Other"),
    legal_entity_type = str_replace(legal_entity_type, fixed("HES"), "Research & Education"),
    legal_entity_type = str_replace(legal_entity_type, fixed("REC"), "Research & Education"),
    legal_entity_type = str_replace(legal_entity_type, fixed("PRC"), "Other (Excl. R&Ed)"),
    legal_entity_type = str_replace(legal_entity_type, fixed("PUB"), "Other (Excl. R&Ed)"),
    legal_entity_type = str_replace(legal_entity_type, fixed("OTH"), "Other (Excl. R&Ed)")
  ) %>%
  group_by(
    Pillar = pillar_abbr, 
    Affiliation = legal_entity_type
  ) %>%
  summarise(
  `Participation Count` = n(),
  `Nb Projects` = n_distinct(project_nbr),
  `EU Contribution` = sum(eu_contribution, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(Affiliation = fct_rev(Affiliation)) %>%
  arrange(Pillar, Affiliation) %>%
  ggplot(aes(x = fct_rev(Pillar), y = `EU Contribution`, fill = Affiliation)) +
  geom_col(position = position_stack(reverse = TRUE)) +
  scale_fill_nejm() +
  scale_y_continuous(labels=unit_format(suffix="", scale = 1e-6, big.mark = ",")) +
  coord_flip() +
  theme_minimal(base_size = 16) +
  labs(
    title = "Swiss R&Ed Organisations Receive Most of the Funding in Pillar 1",
    x = "Pillar",
    y = "EU Contribution to CH (MioEUR)"
  ) +
  theme(
    plot.title.position = "plot",
    legend.position = "top",
    legend.title = element_blank(),
    axis.title.y = element_text(
      angle = 0, 
      vjust = 1.1, 
      margin = margin(r = -40))
  )
```

#### CERN

```{r cern}
total_cern <- df %>%
  filter(country_code == "CH") %>%
  filter(legal_name == "EUROPEAN ORGANIZATION FOR NUCLEAR RESEARCH") %>%
  summarise(total_eu_contrib = sum(eu_contribution, na.rm = TRUE)) %>%
  pull() %>%
  format(
    big.mark = ",",
    decimal.mark = ".",
    trim = TRUE,
    digits = 11)
```

**Note**: EU Contribution to Switzerland include `r str_c("â‚¬", total_cern)` awarded to the CERN.  Please see the EU contribution to CERN detailed below:

```{r cern-detail}
df %>%
  filter(country_code == "CH") %>%
  filter(legal_name == "EUROPEAN ORGANIZATION FOR NUCLEAR RESEARCH") %>%
  group_by(Pillar = pillar_descr, Priority = thematic_priority_abbr) %>%
  summarise(`EU Contribution` = sum(eu_contribution, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(Share = `EU Contribution` / sum(`EU Contribution`)) %>%
  arrange(desc(Share)) %>%
  reactable(
    columns = list(
      `EU Contribution` = colDef(
        format = colFormat(
          currency = "EUR",
          separators = TRUE, 
          digits = 10),
        footer = function(values) sum(values) %>% format(big.mark = ",") %>% str_c("â‚¬", .)),
      Share = colDef(format = colFormat(percent = TRUE, digits = 1)),
      Pillar = colDef(footer = "Total")
    ),
    defaultColDef = colDef(footerStyle = list(fontWeight = "bold")),
    highlight = TRUE,
    compact = TRUE
  )
```

## Annex

The raw data contains 176,512 rows with the following details on every participant on each project:

```{r}
df %>%
  glimpse()
```

