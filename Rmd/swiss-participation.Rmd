---
title: "ðŸš§ Swiss Participation in EU Framework Programmes ðŸš§"
output: 
  html_document: 
    theme: cerulean
    code_folding: hide
    toc: true
    toc_float: true
    self_contained: false
editor_options: 
  chunk_output_type: console
---

```{r boilerplate}
# source code: https://github.com/zambujo/swissparticipation
library(tidyverse)
library(readxl)
library(here)
library(janitor)
library(reactable)
knitr::opts_chunk$set(message = FALSE)
```

[![](https://img.shields.io/github/issues/zambujo/swissparticipation)](https://github.com/zambujo/swissparticipation/issues)

# H2020 dashboard data

## Raw data

The [**Horizon 2020 Dashboard**](https://webgate.ec.europa.eu/dashboard) project data was last updated 2021-12-06 (see data [here](https://webgate.ec.europa.eu/dashboard/single/?appid=93297a69-09fd-4ef5-889f-b83c4e21d33e&sheet=c616ed33-064c-40c0-803a-e75045b78c05)).  The data contains 176,512 rows with the following details on every participant on each project:

```{r read-dashboard-data}
df <-
  here("data-raw", "horizon2020.xlsx") %>%
  read_excel() %>%
  clean_names()

# minimal cleaning ----
df <- df %>%
  mutate(
    # rename pillars
    pillar_abbr = str_replace(pillar_abbr, fixed("EU.0."), "Cross-theme"),
    pillar_abbr = str_replace(pillar_abbr, fixed("EU.1."), "I"),
    pillar_abbr = str_replace(pillar_abbr, fixed("EU.2."), "II"),
    pillar_abbr = str_replace(pillar_abbr, fixed("EU.3."), "III"),
    pillar_abbr = str_replace(pillar_abbr, fixed("EU.4."), "IV"),
    pillar_abbr = str_replace(pillar_abbr, fixed("EU.5."), "V"),
    # import EU contribution
    eu_contribution = str_replace(eu_contribution, fixed("-"), "0"),
    eu_contribution = as.numeric(eu_contribution),
    # import dates
    signature_date = as.Date(signature_date, format = "%d/%m/%Y"),
    call_deadline_date = as.Date(call_deadline_date, format = "%d/%m/%Y"),
    project_start_date = as.Date(project_start_date, format = "%d/%m/%Y"),
    project_end_date = as.Date(project_end_date, format = "%d/%m/%Y"),
    signature_year = str_sub(signature_date, 1, 4),
    call_year = str_sub(call_deadline_date, 1, 4),
    signature_year = as.integer(signature_year),
    call_year = as.integer(call_year)
  )

df %>%
  glimpse()
```

## Top countries

Participation count, number of projects (distinct), and total EU contribution for the top 10 participating countries (by total EU contribution).

```{r countries}
top10 <- df %>%
  group_by(Country = country) %>%
  summarise(
    `EU Contribution` = sum(eu_contribution, na.rm = TRUE)) %>%
  ungroup() %>%
  arrange(desc(`EU Contribution`)) %>%
  select(Country) %>%
  head(10)

country_participation <- df %>%
  group_by(
    Country = country,
    `Call Year` = call_year,
    Type = legal_entity_type_descr) %>%
  summarise(
    `Participation Count` = n(),
    `Nb Projects` = n_distinct(project_nbr),
    `EU Contribution` = sum(eu_contribution, na.rm = TRUE)) %>%
  ungroup() %>%
  arrange(`Type`, `Call Year`)
  
top10 %>%
  inner_join(country_participation, by = "Country") %>%
  reactable(
    groupBy = c("Country", "Call Year"),
    columns = list(
      `Participation Count` = colDef(
        aggregate = "sum",
        format = colFormat(separators = TRUE)),
      `Nb Projects` = colDef(
        aggregate = "sum", 
        format = colFormat(separators = TRUE)),
      `EU Contribution` = colDef(
        aggregate = "sum",
        format = colFormat(currency = "EUR", separators = TRUE, digits = 2))
    ),
    highlight = TRUE,
    compact = TRUE
  )
```

### Visual Summary

```{r visual-countries}
df %>%
  group_by(Country = country) %>%
  summarise(
    `EU Contribution` = sum(eu_contribution, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(Country = fct_lump(Country, 10, w = `EU Contribution`)) %>%
  group_by(Country) %>%
  summarise(
    `EU Contribution` = sum(`EU Contribution`, na.rm = TRUE)) %>%
  ungroup() %>%
  arrange(desc(`EU Contribution`)) %>%
  mutate(
    contrib_txt = format(
      `EU Contribution`,
      big.mark = ",",
      decimal.mark = ".",
      trim = TRUE,
      digits = 12),
    contrib_txt = str_c("â‚¬", contrib_txt)) %>%
    write_csv(here("data", "h2020-countries-treemap.csv"))
```

![](https://raw.githubusercontent.com/zambujo/swissparticipation/main/data/treemap-countries.svg "A treemap of total EU contribution to the top 10 countries participating in H2020.")


## Swiss participation: an overview

Swiss participation in H2020: participation count, number of projects (distinct), total EU contribution by pillar, thematic priority, and call year.

```{r overview}
df %>%
  filter(country_code == "CH") %>%
  group_by(
    Pillar = pillar_abbr, 
    Priority = thematic_priority_abbr, 
    `Call Year` = call_year) %>%
  summarise(
    `Participation Count` = n(),
    `Nb Projects` = n_distinct(project_nbr),
    `EU Contribution` = sum(eu_contribution, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(
    `EU Contribution` = round(`EU Contribution`, 1)
  ) %>%
  reactable(
    groupBy = c("Pillar", "Priority"),
    columns = list(
      `Participation Count` = colDef(
        aggregate = "sum", 
        format = colFormat(separators = TRUE)),
      `Nb Projects` = colDef(
        aggregate = "sum", 
        format = colFormat(separators = TRUE)),
      `EU Contribution` = colDef(
        aggregate = "sum",
        format = colFormat(currency = "EUR", separators = TRUE, digits = 2))
    ),
    highlight = TRUE,
    compact = TRUE
  )
```


```{r visual-overview}
stats_depth_1 <-
  df %>%
  filter(country_code == "CH") %>%
  filter(!pillar_abbr %in% c("I", "II", "III")) %>%
  group_by(pillar_abbr, pillar_descr) %>%
  summarise(total_eu_contrib = sum(eu_contribution, na.rm = TRUE)) %>%
  ungroup() %>%
  unite("pillar", starts_with("pillar"), sep = ". ") %>%
  mutate(
    pillar = str_replace(pillar,
                         fixed("Cross-theme. Cross-theme"),
                         "Cross-theme"),
    pillar = str_replace(
      pillar,
      fixed("Euratom. Euratom Research and Training Programme"),
      "Euratom"
    ),
    thematic_priority_abbr = NA
  ) %>%
  select(pillar,
         thematic_priority = thematic_priority_abbr,
         contrib = total_eu_contrib)

stats_depth_2 <- df %>%
  filter(country_code == "CH") %>%
  filter(pillar_abbr %in% c("I", "II", "III")) %>%
  # simple stats
  group_by(pillar_abbr, pillar_descr, thematic_priority_abbr) %>%
  summarise(total_eu_contrib = sum(eu_contribution, na.rm = TRUE)) %>%
  ungroup() %>%
  # for printing
  unite("pillar", starts_with("pillar"), sep = ". ") %>%
  select(pillar,
         thematic_priority = thematic_priority_abbr,
         contrib = total_eu_contrib)

# for treemap with https://rawgraphs.io
stats_depth_1 %>%
  bind_rows(stats_depth_2) %>%
  arrange(pillar, desc(contrib)) %>%
  mutate(
    thematic_priority = replace_na(thematic_priority, ""),
    contrib_txt = contrib / 1000000,
    contrib_txt = format(
      contrib_txt,
      big.mark = ",",
      decimal.mark = ".",
      trim = TRUE,
      digits = 2),
    contrib_txt = str_c("Mâ‚¬", contrib_txt)) %>%
  write_csv(here("data", "h2020-treemap.csv"))
```


### Visual summary

A treemap of the overall H2020 EU contribution (MEUR) to Switzerland by Pillar and Thematic Priority.

![](https://raw.githubusercontent.com/zambujo/swissparticipation/main/data/treemap.svg "A treemap of EU H2020 contribution to Swiss participants, by pillar and thematic priority.")