---
title: "Swiss Participation in EU Framework Programmes"
author: "João Martins"
output: 
  html_document: 
    theme: cerulean
    code_folding: hide
    toc: true
    toc_float: true
    self_contained: false
editor_options: 
  chunk_output_type: console
---

```{r boilerplate, message=FALSE}
# source code: https://github.com/zambujo/swissparticipation
library(tidyverse)
library(janitor)
library(here)
library(readxl)
library(scales)
library(ggsci)
library(reactable)
knitr::opts_chunk$set(message = FALSE)
int <- function(x) as.integer(x)
chr <- function(x) as.character(x)
roman <- function(x) as.roman(x)
```

<!-- badges: start -->
[![](https://img.shields.io/github/watchers/zambujo/swissparticipation?style=social)](https://github.com/zambujo/swissparticipation)
[![](https://img.shields.io/github/issues/zambujo/swissparticipation)](https://github.com/zambujo/swissparticipation/issues)
<!-- badges: end -->

> Pease find related statistics on the SERI's page: [Facts and Figures on the Swiss Participation in the EU-Framework Programmes for Research and Innovation](https://www.sbfi.admin.ch/sbfi/en/home/research-and-innovation/international-cooperation-r-and-i/eu-framework-programmes-for-research/f-f-swiss-participation.html).

## Data

Source: [**Horizon 2020 Dashboard data**](https://webgate.ec.europa.eu/dashboard/single/?appid=93297a69-09fd-4ef5-889f-b83c4e21d33e&sheet=c616ed33-064c-40c0-803a-e75045b78c05), last updated on 2021-12-06 (see [Annex: Raw Data](#raw-data)).

```{r read-dashboard-data}
# load xlsx table to a data frame
df <-
  here("data-raw", "horizon2020.xlsx") %>%
  read_excel() %>%
  clean_names()

# minimal cleaning ----
df <- df %>%
  mutate(
    # rename role
    partner_role = str_to_title(partner_role),
    # factorize pillars
    pillar = str_extract(pillar_abbr, "\\d"),
    pillar = if_else(pillar_abbr == "EU.0.", "Cross-theme", pillar),
    pillar = if_else(pillar_abbr == "Euratom", pillar_abbr, pillar),
    pillar = fct_inseq(pillar),
    pillar = fct_rev(pillar),
    pillar = fct_relevel(pillar, "Cross-theme", after = 0),
    pillar = fct_recode(
      pillar, I = "1", II = "2", III = "3", IV = "4", V = "5"),
    # group entity types
    org_type = fct_collapse(
      legal_entity_type,
      `Research & Education` = c("HES", "REC"),
      `Others (Excl. R&Ed)` = c("PRC", "PUB", "OTH")),
    # import EU contribution
    eu_contribution = str_replace(eu_contribution, fixed("-"), "0"),
    eu_contribution = as.numeric(eu_contribution),
    # import dates
    signature_date = as.Date(signature_date, format = "%d/%m/%Y"),
    call_deadline_date = as.Date(call_deadline_date, format = "%d/%m/%Y"),
    project_start_date = as.Date(project_start_date, format = "%d/%m/%Y"),
    project_end_date = as.Date(project_end_date, format = "%d/%m/%Y"),
    signature_year = str_sub(signature_date, 1, 4),
    call_year = str_sub(call_deadline_date, 1, 4),
    signature_year = as.integer(signature_year),
    call_year = as.integer(call_year)
  )
```

## Total EU Contribution by Pillar (All Countries)

```{r overview-pillar, eval=FALSE}
ggp <- df %>%
  mutate(
    pillar = fct_other(pillar, keep = chr(roman(1:5))),
    pillar = fct_relevel(pillar, "Other", after = 0)) %>%
  group_by(pillar) %>%
  summarise(size_pillar = sum(eu_contribution)) %>%
  mutate(share = 100 * prop.table(size_pillar),
         fp = "H2020") %>%
  ggplot(aes(x = fp,  y = size_pillar, fill = pillar)) +
  geom_col(position = position_stack()) +
  geom_text(
    aes(label = sprintf("%.1f%%", share)),
    position = position_stack(vjust = 0.5),
    size = 4,
    fontface = "bold"
  ) +
  coord_flip() +
  scale_fill_nejm(alpha = .5, guide = guide_legend(reverse = TRUE)) +
  theme_minimal(base_size = 14) +
  labs(x = NULL, y = NULL) +
  theme(
    legend.position = "bottom",
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank()
  )

ggsave("budget-allocation.svg",
       plot = ggp,
       w = 12,
       h = 3)
```

![](https://raw.githubusercontent.com/zambujo/swissparticipation/main/data/budget-allocation.svg "Total EU contribution to the different pillars in H2020.")

## Top countries

Participation count, number of projects (distinct), and total EU contribution for the top 10 participating countries (by total EU contribution).

```{r top-participants}
# find and sort top participants
top_participants <- df %>%
  group_by(Country = country) %>%
  summarise(contrib_country = sum(eu_contribution)) %>%
  ungroup() %>%
  arrange(desc(contrib_country))

ch_rank <- which(pull(top_participants, Country) == "Switzerland")

# calculate further participation statistics
country_participation <- df %>%
  group_by(
    Country = country,
    `Call Year` = call_year,
    Type = org_type) %>%
  summarise(
    `Participation Count` = n(),
    `Nb Projects` = n_distinct(project_nbr),
    `EU Contribution` = sum(eu_contribution, na.rm = TRUE)) %>%
  ungroup() %>%
  arrange(`Type`, `Call Year`)

# show with reactable
top_participants %>%
  select(Country) %>%
  head(10) %>%
  inner_join(country_participation, by = "Country") %>%
  reactable(
    groupBy = c("Country", "Call Year"),
    columns = list(
      `Participation Count` = colDef(
        aggregate = "sum",
        format = colFormat(separators = TRUE)),
      `Nb Projects` = colDef(
        aggregate = "sum",
        format = colFormat(separators = TRUE)),
      `EU Contribution` = colDef(
        aggregate = "sum",
        format = colFormat(
          currency = "EUR",
          separators = TRUE,
          digits = 2))),
    highlight = TRUE,
    compact = TRUE
  )
```

Without excluding the CERN (see [Annex: CERN](#cern)), Switzerland ranks `r ch_rank`th by total EU contribution in H2020.

```{r visual-countries, fig.asp=.5}
# minimal plotting
pal <- c(
  rep("gray85", ch_rank - 1),
  "goldenrod1",
  rep("gray85", 10 - ch_rank)) %>%
  rev()

top_participants %>%
  mutate(
    Country = fct_rev(fct_inorder(Country)),
    share = 100 * prop.table(contrib_country)) %>%
  head(10) %>%
  ggplot(aes(x = contrib_country, y = Country, fill = Country)) +
  geom_col() +
  geom_text(aes(
    label = sprintf("%.1f%%", share)),
    hjust = 1.15,
    size = 4,
    fontface = "bold",
    family = "Fira Sans") +
  labs(x = NULL,y = NULL) +
  scale_fill_manual(values = pal, guide = "none") +
  theme_void() +
  theme(
    plot.margin = margin(c(4, 2, 4, 8)),
    axis.text.y = element_text(size = 14, hjust = 1, family = "Fira Sans"))

# thanks: 
# https://www.cedricscherer.com/2021/07/05/a-quick-how-to-on-labelling-bar-graphs-in-ggplot2/
```

## Swiss participation: an overview

```{r get-participation}
get_participation <- function(x) {
  x %>%
    mutate(pillar = fct_rev(pillar)) %>%
    group_by(Pillar = pillar,
             Priority = thematic_priority_abbr,
             `Call Year` = call_year) %>%
    summarise(
      `Participation Count` = n(),
      `Nb Projects` = n_distinct(project_nbr),
      `EU Contribution` = sum(eu_contribution, na.rm = TRUE)
    ) %>%
    ungroup() %>%
    mutate(`EU Contribution` = round(`EU Contribution`, 1)) %>%
    reactable(
      groupBy = c("Pillar", "Priority"),
      columns = list(
        Pillar = colDef(footer = "Total"),
        `Participation Count` = colDef(
          aggregate = "sum",
          format = colFormat(separators = TRUE),
          footer = function(values)
            sum(values) %>% format(big.mark = ",")
        ),
        `Nb Projects` = colDef(
          aggregate = "sum",
          format = colFormat(separators = TRUE),
          footer = function(values)
            sum(values) %>% format(big.mark = ",")
        ),
        `EU Contribution` = colDef(
          aggregate = "sum",
          format = colFormat(
            currency = "EUR",
            separators = TRUE,
            digits = 2
          ),
          footer = function(values)
            sum(values) %>% format(big.mark = ",") %>% str_c("€", .)
        )
      ),
      defaultColDef = colDef(footerStyle = list(fontWeight = "bold")),
      highlight = TRUE,
      compact = TRUE
    )
}
```

Swiss participation in H2020: participation count, number of projects (distinct), total EU contribution by pillar, thematic priority, and call year.

```{r overview}
df %>%
  filter(country_code == "CH") %>%
  get_participation()
```

```{r visual-overview, eval=FALSE}
# Differentiate pillars 1 to III
stats_depth_1 <- 
  df %>%
  filter(country_code == "CH") %>%
  filter(!pillar %in% chr(roman(1:3))) %>%
  mutate(pillar = fct_rev(pillar)) %>%
  group_by(pillar, pillar_descr) %>%
  summarise(total_eu_contrib = sum(eu_contribution)) %>%
  ungroup() %>%
  # for printing
  mutate(pillar_descr = ifelse(
    chr(pillar) %in% chr(roman(4:5)), 
    str_c(pillar, ". ", pillar_descr),
    chr(pillar)),
    thematic_priority_abbr = NA) %>%
  # for binding
  select(pillar = pillar_descr,
         thematic_priority = thematic_priority_abbr,
         contrib = total_eu_contrib)

stats_depth_2 <- df %>%
  filter(country_code == "CH") %>%
  filter(pillar %in% chr(roman(1:3))) %>%
  mutate(pillar = fct_rev(pillar)) %>%
  group_by(pillar, pillar_descr, thematic_priority_abbr) %>%
  summarise(total_eu_contrib = sum(eu_contribution)) %>%
  ungroup() %>%
  # for printing
  unite("pillar", starts_with("pillar"), sep = ". ") %>%
  # for binding
  select(pillar,
         thematic_priority = thematic_priority_abbr,
         contrib = total_eu_contrib)

stats_depth_2 %>%
bind_rows(stats_depth_1) %>%
  mutate(
    thematic_priority = replace_na(thematic_priority, ""),
    contrib_txt = contrib / 1000000,
    contrib_txt = format(
      contrib_txt,
      big.mark = ",",
      decimal.mark = ".",
      trim = TRUE,
      digits = 2),
    contrib_txt = str_c("M€", contrib_txt)) %>%
  write_csv(here("data", "h2020-treemap.csv"))
# plot with https://rawgraphs.io
```

Treemap showing the overall H2020 EU contribution (MEUR) to Switzerland by Pillar and Thematic Priority. Only the three largest pillars are shown.

![](https://raw.githubusercontent.com/zambujo/swissparticipation/main/data/treemap-ch.svg "H2020 EU contribution to Swiss participants, by pillar and thematic priority.")

### Swiss participation by sector

```{r ch-type-role, fig.asp=.6}
df %>%
  filter(country_code == "CH") %>%
  mutate(
    pillar = fct_other(pillar, keep = chr(roman(1:5))),
    pillar = fct_relevel(pillar, "Other", after = 0)) %>%
  group_by(pillar, org_type, role = partner_role) %>%
  summarise(contrib = sum(eu_contribution)) %>%
  ungroup() %>%
  mutate(org_type = fct_rev(org_type)) %>%
  arrange(pillar, org_type) %>%
  ggplot(aes(x = pillar, y = contrib, fill = org_type)) +
  geom_col(position = position_stack(reverse = FALSE)) +
  scale_fill_nejm(alpha = .5, guide = guide_legend(reverse = TRUE)) +
  scale_y_continuous(labels=unit_format(suffix="", scale = 1e-6, big.mark = ",")) +
  coord_flip() +
  facet_grid(role ~ .) +
  theme_minimal(base_size = 14) +
  labs(
    title = "Pillar I is the primary source of funding for CH",
    subtitle = "With a high proportion of Research & Education organisations",
    x = "Pillar",
    y = "EU Contribution to Swiss Institutions (MioEUR)"
  ) +
  theme(
    plot.title.position = "plot",
    legend.position = "bottom",
    legend.title = element_blank()
  )
```

#### EU contributions commited to Swiss institutions in research and higher education

```{r overview-in-research}
df %>%
  filter(country_code == "CH") %>%
  filter(org_type == "Research & Education") %>%
  get_participation()
```

---

## Annex

### Raw Data

The raw data contains 176,512 rows with the following details on every participant on each project:

```{r}
df %>%
  glimpse()
```

### CERN

```{r cern-total}
total_cern <- df %>%
  filter(country_code == "CH") %>%
  filter(legal_name == "EUROPEAN ORGANIZATION FOR NUCLEAR RESEARCH") %>%
  summarise(total_eu_contrib = sum(eu_contribution)) %>%
  pull() %>%
  format(big.mark = ",", decimal.mark = ".", trim = TRUE, digits = 11)
```

**Note**: EU Contribution to Switzerland include `r str_c("€", total_cern)` awarded to the CERN.  Please find the EU contribution to CERN in detail below:

```{r cern-detail}
df %>%
  filter(country_code == "CH") %>%
  filter(legal_name == "EUROPEAN ORGANIZATION FOR NUCLEAR RESEARCH") %>%
  get_participation()
```
