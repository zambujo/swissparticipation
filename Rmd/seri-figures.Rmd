---
title: "FP7 & H2020 Figures"
output: 
  html_document:
    self_contained: no
---

```{r boilerplate, include=FALSE}
# source code: https://github.com/zambujo/swissparticipation
library(tidyverse)
library(janitor)
library(lubridate)
library(here)
library(yaml)
library(glue)
library(scales)
library(ggsci)
library(ggrepel)
library(ggtext)
library(reactable)
source(here("R", "utils.R"))
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  comment = FALSE
)

```

```{r read-dashboard-data}
df_schema <- here("data", "schema-cordis-plus.yml") %>%
  read_yaml() %>%
  as.list()

df_raw <-
  list.files(here("data"), pattern = "cordis-plus-", full.names = TRUE) %>%
  map_df(read_csv, col_types = df_schema)

df_raw <-
  df_raw %>%
  mutate(
    pillar = fct_inseq(pillar),
    pillar = fct_rev(pillar),
    pillar = fct_relevel(pillar, "Cross-theme", after = 0),
    pillar = fct_recode(
      pillar, I = "1", II = "2", III = "3", IV = "4", V = "5"),
    org_type = fct_collapse(
      legal_entity_type,
      `Research & Education` = c("HES", "REC"),
      `Others (Excl. R&Ed)` = c("PRC", "PUB", "OTH")))

df <- df_raw %>%
    mutate(start_semester = floor_date(start_date, "6 months")) %>%
    # remove the CERN
    filter(legal_name != "EUROPEAN ORGANIZATION FOR NUCLEAR RESEARCH")
```

## An Overview of Swiss Participation  {.tabset .tabset-fade .tabset-pills}

```{r plot-styling}
bar_plt <- function(plt) {
  plt +
  geom_col() +
  theme_minimal() +
  theme(
    plot.title.position = "plot",
    text = element_text(
      size = 15,
      family = "Gill Sans",
      color = "gray15"
    )
  )
}

get_particip <- function(x, in_programme = "") {
  if (in_programme == "FP7") {
    x <- x %>%
      filter(framework_programme == "FP7")
  }
  if (in_programme == "H2020") {
    x <- x %>%
      filter(framework_programme == "H2020")
  }
  total <- x %>%
    count(year = start_year, name = "n_total")
  ch <- x %>%
    filter(country_code == "CH") %>%
    count(year = start_year, name = "n_ch")

  left_join(total, ch, by = "year") %>%
    mutate(share_particip = 100 * n_ch / n_total)
}

get_contrib <- function(x, in_programme = "") {
  if (in_programme == "FP7") {
    x <- x %>%
      filter(framework_programme == "FP7")
  }
  if (in_programme == "H2020") {
    x <- x %>%
      filter(framework_programme == "H2020")
  }
  to_all <- x %>%
    group_by(year = start_year) %>%
    summarise(contrib_all = sum(re_contribution, na.rm = TRUE))
  to_ch <- x %>%
    filter(country_code == "CH") %>%
    group_by(year = start_year) %>%
    summarise(contrib_ch = sum(re_contribution, na.rm = TRUE))

  left_join(to_all, to_ch, by = "year") %>%
    mutate(share_contrib = 100 * contrib_ch / contrib_all)
}

get_coord <- function(x, in_programme = "") {
  if (in_programme == "FP7") {
    x <- x %>%
      filter(framework_programme == "FP7")
  }
  if (in_programme == "H2020") {
    x <- x %>%
      filter(framework_programme == "H2020")
  }
  
  all <- x %>%
    filter(partner_role == "Coordinator") %>%
    count(year = start_year, name = "coord_total")
  ch <- x %>%
    filter(country_code == "CH") %>%
    filter(partner_role == "Coordinator") %>%
    count(year = start_year, name = "coord_ch")

  left_join(all, ch, by = "year") %>%
    mutate(share_contrib = 100 * coord_ch / coord_total)
}
```

**For the official figures, please visit [SERI's page](https://www.sbfi.admin.ch/sbfi/en/home/research-and-innovation/international-cooperation-r-and-i/eu-framework-programmes-for-research/f-f-swiss-participation.html).**

### Share Swiss Participations

```{r swiss-participations}
df %>%
  get_particip() %>%
  ggplot(aes(x = year, y = share_particip)) %>%
  bar_plt() +
  labs(
    title = "Swiss Participation",
    subtitle = "By project starting year, FP7 and H2020",
    x = "Project Starting Year",
    y = "%"
  ) +
  annotate(
    "rect",
    xmin = 2006.5,
    xmax = 2014.5,
    ymin = -.1,
    ymax = 3.55,
    fill = "#21325E",
    alpha = .1
  ) +
  annotate(
    "rect",
    xmin = 2014.5,
    xmax = 2022.5,
    ymin = -.1,
    ymax = 3.55,
    fill = "#F1D00A",
    alpha = .1
  ) +
  annotate(
    "text",
    x = c(2010, 2019),
    y = c(3.65, 3.65),
    label = c("FP7", "H2020"),
    family = "Gill Sans"
  )
```

#### FP7 Summary

```{r swiss-participations-fp7}
df %>%
  get_particip(in_programme = "FP7") %>%
  select(`CH Participations` = n_ch,
         `Total Participations` = n_total) %>%
  summarise_all(sum, na.rm = TRUE) %>%
  mutate(`Average Participation (%)` = round(
    100 * `CH Participations` / `Total Participations`, 1)) %>%
  reactable()

```

#### H2020 Summary

```{r swiss-participations-h2020}
df %>%
  get_particip(in_programme = "H2020") %>%
  select(`CH Participations` = n_ch,
         `Total Participations` = n_total) %>%
  summarise_all(sum, na.rm = TRUE) %>%
  mutate(`Average Participation (%)` = round(
    100 * `CH Participations` / `Total Participations`, 1)) %>%
  reactable()
```

### Contribution to Swiss Participants

```{r swiss-countributions}
df %>%
  get_contrib() %>%
  ggplot(aes(x = year, y = share_contrib)) %>%
  bar_plt() +
  labs(
    title = "Contributions to Swiss Participants",
    subtitle = "By project starting year, FP7 and H2020",
    x = "Project Starting Year",
    y = "%"
  ) +
  annotate(
    "rect",
    xmin = 2006.5,
    xmax = 2014.5,
    ymin = -.1,
    ymax = 5.75,
    fill = "#21325E",
    alpha = .1
  ) +
  annotate(
    "rect",
    xmin = 2014.5,
    xmax = 2022.5,
    ymin = -.1,
    ymax = 5.75,
    fill = "#F1D00A",
    alpha = .1
  ) +
  annotate(
    "text",
    x = c(2010, 2019),
    y = c(6, 6),
    label = c("FP7", "H2020"),
    family = "Gill Sans"
  )
```

#### FP7 Summary

```{r contributions-ch-fp7}
df %>%
  get_contrib(in_programme = "FP7") %>%
  select(`Contribution to CH` = contrib_ch,
         `Contribution to All` = contrib_all) %>%
  summarise_all(sum, na.rm = TRUE) %>%
  mutate(`Average Contribution to CH (%)` = round(
    100 * `Contribution to CH` / `Contribution to All`, 1)) %>%
  reactable()

```

#### H2020 Summary

```{r contributions-ch-h2020}
df %>%
  get_contrib(in_programme = "H2020") %>%
  select(`Contribution to CH` = contrib_ch,
         `Contribution to All` = contrib_all) %>%
  summarise_all(sum, na.rm = TRUE) %>%
  mutate(`Average Contribution to CH (%)` = round(
    100 * `Contribution to CH` / `Contribution to All`, 1)) %>%
  reactable()
```

### Swiss Coordinations

```{r coordinations-overviews}
df %>%
  get_coord() %>%
  ggplot(aes(x = year, y = share_contrib)) %>%
  bar_plt() +
  labs(
    title = "Swiss Coordinations",
    subtitle = "By project starting year, FP7 and H2020",
    x = "Project Starting Year",
    y = "%"
  ) +
  annotate(
    "rect",
    xmin = 2006.5,
    xmax = 2014.5,
    ymin = -.1,
    ymax = 5.6,
    fill = "#21325E",
    alpha = .1
  ) +
  annotate(
    "rect",
    xmin = 2014.5,
    xmax = 2022.5,
    ymin = -.1,
    ymax = 5.6,
    fill = "#F1D00A",
    alpha = .1
  ) +
  annotate(
    "text",
    x = c(2010, 2019),
    y = c(5.8, 5.8),
    label = c("FP7", "H2020"),
    family = "Gill Sans"
  )
```

#### FP7 Summary

```{r coordinations-ch-fp7}
df %>%
  get_coord(in_programme = "FP7") %>%
  select(`CH Coordinations` = coord_ch, `All Coordinations` = coord_total) %>%
  summarise_all(sum, na.rm = TRUE) %>%
  mutate(`Average CH Coordinations (%)` = round(100 * `CH Coordinations` / `All Coordinations`, 1)) %>%
  reactable()

```

#### H2020 Summary

```{r coordinations-ch-h2020}
df %>%
  get_coord(in_programme = "H2020") %>%
  select(`CH Coordinations` = coord_ch, `All Coordinations` = coord_total) %>%
  summarise_all(sum, na.rm = TRUE) %>%
  mutate(`Average CH Coordinations (%)` = round(100 * `CH Coordinations` / `All Coordinations`, 1)) %>%
  reactable()
```


## Top Participating Countries  {.tabset .tabset-fade .tabset-pills}

Switzerland ranks 7th by total EU contribution in FP7 and 8th in H2020. (The CERN is not taken into account, see [CERN](#cern)).

### FP7

Participation count, number of projects (distinct), and total EU contribution for the top 10 participating countries (by total EU contribution).

```{r top-participants-fp7}
# find and sort top participants
top_participants <- df %>%
  filter(framework_programme == "FP7") %>%
  group_by(Country = country) %>%
  summarise(contrib_country = sum(re_contribution, na.rm = TRUE)) %>%
  ungroup() %>%
  arrange(desc(contrib_country))

ch_rank <- which(pull(top_participants, Country) == "Switzerland")

# calculate further participation statistics
country_participation <- df %>%
  filter(framework_programme == "FP7") %>%
  group_by(
    Country = country,
    `Project Start Year` = start_year,
    Type = org_type
  ) %>%
  summarise(
    `Participation Count` = n(),
    `Nb Projects` = n_distinct(project_id),
    `EU Contribution` = sum(re_contribution, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  arrange(`Type`, `Project Start Year`)
```

```{r visual-countries-fp7, fig.asp=.5}
# minimal plotting
pal <- c(
  rep("#DFD8CA", ch_rank - 1),
  "#B91646",
  rep("#DFD8CA", 10 - ch_rank)) %>%
  rev()

top_participants %>%
  mutate(
    Country = fct_rev(fct_inorder(Country)),
    share = 100 * prop.table(contrib_country)
  ) %>%
  head(10) %>%
  ggplot(aes(x = contrib_country, y = Country, fill = Country)) +
  geom_col() +
  geom_text(
    aes(label = sprintf("%.1f%%", share)),
    hjust = 1.15,
    size = 4,
    fontface = "bold",
    family = "Gill Sans"
  ) +
  labs(x = NULL, y = NULL) +
  scale_fill_manual(values = pal, guide = "none") +
  theme_void() +
  theme(
    plot.margin = margin(c(4, 2, 4, 8)),
    axis.text.y = element_text(
      margin = margin(t = 0, r = -10, b = 0, l = 5),
      size = 14,
      family = "Gill Sans",
      hjust = 1,
      color = "gray10"
    )
  )
```

```{r}
top_participants %>%
  select(Country) %>%
  head(10) %>%
  inner_join(country_participation, by = "Country") %>%
  reactable(
    groupBy = c("Country", "Project Start Year"),
    columns = list(
      `Participation Count` = colDef(
        aggregate = "sum",
        format = colFormat(separators = TRUE)
      ),
      `Nb Projects` = colDef(
        aggregate = "sum",
        format = colFormat(separators = TRUE)
      ),
      `EU Contribution` = colDef(
        aggregate = "sum",
        format = colFormat(
          currency = "EUR",
          separators = TRUE,
          digits = 2
        )
      )
    ),
    highlight = TRUE,
    compact = TRUE
  )
```


### H2020

Participation count, number of projects (distinct), and total EU contribution for the top 10 participating countries (by total EU contribution).

```{r top-participants}
# find and sort top participants
top_participants <- df %>%
  filter(framework_programme == "H2020") %>%
  group_by(Country = country) %>%
  summarise(contrib_country = sum(eu_contribution, na.rm = TRUE)) %>%
  ungroup() %>%
  arrange(desc(contrib_country))

ch_rank <- which(pull(top_participants, Country) == "Switzerland")

# calculate further participation statistics
country_participation <- df %>%
  filter(framework_programme == "H2020") %>%
  group_by(
    Country = country,
    `Call Year` = call_year,
    Type = org_type
  ) %>%
  summarise(
    `Participation Count` = n(),
    `Nb Projects` = n_distinct(project_id),
    `EU Contribution` = sum(eu_contribution, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  arrange(`Type`, `Call Year`)
```

```{r visual-countries, fig.asp=.5}
# minimal plotting
pal <- c(
  rep("#DFD8CA", ch_rank - 1),
  "#B91646",
  rep("#DFD8CA", 10 - ch_rank)) %>%
  rev()

top_participants %>%
  mutate(
    Country = fct_rev(fct_inorder(Country)),
    share = 100 * prop.table(contrib_country)
  ) %>%
  head(10) %>%
  ggplot(aes(x = contrib_country, y = Country, fill = Country)) +
  geom_col() +
  geom_text(
    aes(label = sprintf("%.1f%%", share)),
    hjust = 1.15,
    size = 4,
    fontface = "bold",
    family = "Gill Sans"
  ) +
  labs(x = NULL, y = NULL) +
  scale_fill_manual(values = pal, guide = "none") +
  theme_void() +
  theme(
    plot.margin = margin(c(4, 2, 4, 8)),
    axis.text.y = element_text(
      margin = margin(t = 0, r = -10, b = 0, l = 5),
      size = 14,
      family = "Gill Sans",
      hjust = 1,
      color = "gray10"
    )
  )
```

```{r}
# show with reactable
top_participants %>%
  select(Country) %>%
  head(10) %>%
  inner_join(country_participation, by = "Country") %>%
  reactable(
    groupBy = c("Country", "Call Year"),
    columns = list(
      `Participation Count` = colDef(
        aggregate = "sum",
        format = colFormat(separators = TRUE)
      ),
      `Nb Projects` = colDef(
        aggregate = "sum",
        format = colFormat(separators = TRUE)
      ),
      `EU Contribution` = colDef(
        aggregate = "sum",
        format = colFormat(
          currency = "EUR",
          separators = TRUE,
          digits = 2
        )
      )
    ),
    highlight = TRUE,
    compact = TRUE
  )
```

---

## CERN

```{r cern}
total_cern_fp7 <- df_raw %>%
  filter(country_code == "CH") %>%
  filter(framework_programme == "FP7") %>%
  filter(legal_name == "EUROPEAN ORGANIZATION FOR NUCLEAR RESEARCH") %>%
  summarise(total_eu_contrib = sum(re_contribution, na.rm = TRUE)) %>%
  pull() %>%
  format(big.mark = ",", decimal.mark = ".", trim = TRUE, digits = 11)

total_cern_h2020 <- df_raw %>%
  filter(country_code == "CH") %>%
  filter(framework_programme == "H2020") %>%
  filter(legal_name == "EUROPEAN ORGANIZATION FOR NUCLEAR RESEARCH") %>%
  summarise(total_eu_contrib = sum(eu_contribution, na.rm = TRUE)) %>%
  pull() %>%
  format(big.mark = ",", decimal.mark = ".", trim = TRUE, digits = 11)
```

EU Contribution to CERN amounted to `r str_c("€", total_cern_fp7)` under FP7 and to `r str_c("€", total_cern_h2020)` under H2020.

```{r cern-detail, eval=FALSE}
# TODO: add get_participation to utils.R
df_raw %>%
  filter(country_code == "CH") %>%
  filter(legal_name == "EUROPEAN ORGANIZATION FOR NUCLEAR RESEARCH") %>%
  get_participation()
```



