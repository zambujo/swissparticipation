---
title: "Gathering FP Data for Analysis"
output: 
  html_document:
    self_contained: no
editor_options: 
  chunk_output_type: console
---

## Data Sources

The raw data is available at:

- [CORDIS](https://cordis.europa.eu/), **updated 2022-01-18**
  - [CORDIS FP7 projects](https://data.europa.eu/data/datasets/cordisfp7projects)  
  - [CORDIS H2020 projects](https://data.europa.eu/data/datasets/cordish2020projects)
  - [CORDIS reference data](https://data.europa.eu/data/datasets/cordisref-data)
  - [Country data](https://cordis.europa.eu/data/reference/cordisref-countries.csv)
- [**Horizon Dashboard**](https://webgate.ec.europa.eu/dashboard), **updated 2021-12-06**
  - ➡ `Everyone` ➡ `FP7 Projects` ➡ `FP7 Project Details` ➡ `Top Funded Projects`  
  - ➡ `Everyone` ➡ `H2020 Projects` ➡ `H2020 Projects` ➡ `Top Funded Projects`  
  - ➡ `Everyone` ➡ `H2020 Projects` ➡ `Data Export` ➡ `Raw Data Export Sheet`

Horizon Europe project data not yet centrally published.

```{r, include=FALSE}
# prevent chunks from running, by default
knitr::opts_chunk$set(
  message = FALSE,
  warning = FALSE,
  comment = FALSE,
  eval = FALSE
)
```

## Data Collection

### CORDIS Data

CORDIS publishes snapshots of its public data in the [EU open data portal](https://data.europa.eu).  The data are provided by framework programme.  For FP7 and H2020, the latest data are now packed in ZIP files containing a collection of CSV datasets.

Below, we  check when were the files last modified
```{r}
source(here::here("R", "package.r"))
source(here::here("R", "utils.r"))

get_last_modified <- function(url) {
  url %>%
    httr::HEAD() %>%
    httr::headers() %>%
    pluck("last-modified")
}

end_points <-
  read_lines(here("inst", "urls.txt"))

# FP6 last modified on 09 Mar 2020 ----
get_last_modified(end_points[1])
get_last_modified(end_points[2])

# updated 18 Jan 2022 ----
get_last_modified(end_points[3])
get_last_modified(end_points[4])
```

then download the data to `data-raw/`
```{r download, comment='', eval=TRUE, echo=FALSE}
cat(readLines(here::here("inst", "download.sh")), sep = '\n')
```

and unzip the archives.
```{r extract}
here("data-raw", "cordis-fp7projects-csv.zip") %>%
  unzip(exdir = here("data-raw", "fp7"))
here("data-raw", "cordis-h2020projects-csv.zip") %>%
  unzip(exdir = here("data-raw", "h2020"))
```

### Horizon Dashboard Data

[Horizon Dashboard](https://webgate.ec.europa.eu/dashboard) is a Qlik Sense application. The raw data is used in official EU statistics.  Unfortunately they cannot be automatically downloaded. It is possible, nevertheless, to manually export a couple of views to Excel (see [Data sources](#data-sources)).

## Data Preprocessing

### Project Details

Horizon Dashboard project data only covers FP7 and H2020. The data is provided in two separate tables, one for each framework programme. To combine both tables, we select the relevant columns:

```{r load-projects-dashboard-data}
fp7_dashboard <-
  here("data-raw", "fp7-projects.xlsx") %>%
  read_excel(guess_max = 20000) %>%
  clean_names() %>%
  select(
    project_id = project_nbr,
    project_acronym,
    thematic_priority = thematic_priority_descr,
    topic_code,
    topic_description,
    participations
  ) %>%
  mutate(framework_programme = "FP7")

h2020_dashboard <-
  here("data-raw", "h2020-projects.xlsx") %>%
  read_excel(guess_max = 20000) %>%
  clean_names() %>%
  select(
    project_id = project_nbr,
    project_acronym,
    thematic_priority = thema,
    topic_code,
    topic_description,
    participations = h2020_participations
  ) %>%
  mutate(framework_programme = "H2020")

projects_dashboard <-
  fp7_dashboard %>%
  bind_rows(h2020_dashboard)
```

CORDIS also provides project data in framework programme specific tables. From CORDIS, we select a few extra columns of interest:

```{r load-projects-cordis-data}
# reconcile schemas using latest schema as reference
projects_cordis_h2020 <-
  read_csv2(here("data-raw", "h2020", "csv", "project.csv")) %>%
  mutate(contentUpdateDate = as.Date(contentUpdateDate))

projects_cordis_fp7 <-
  readr::read_csv2(here("data-raw", "fp7", "csv", "project.csv")) %>%
  mutate(
    contentUpdateDate = as.Date(contentUpdateDate),
    ecSignatureDate = as.Date(ecSignatureDate), # missing
    masterCall = as.character(masterCall)
  ) # missing

projects_cordis <-
  projects_cordis_fp7 %>%
  bind_rows(projects_cordis_h2020) %>%
  clean_names() %>%
  select(
    project_id = id,
    start_date,
    end_date,
    legal_basis,
    funding_scheme
  )
```

And we combine both datasets:

```{r load-projects-data}
projects <-
  projects_dashboard %>%
  left_join(projects_cordis, by = "project_id")
```

As mentioned before, FP6 data are missing from the Horizon Dashboard. In CORDIS, contribution details under FP6 are provided in 2,621 (out of 75,241) cases only.  We will therefore not use FP6 data.  For completeness, we also include the code to read the FP6 data:

```{r fp6, eval=FALSE}
projects_cordis_fp6 <-
  here("data-raw", "cordis-fp6projects.csv") %>%
  readr::read_csv2() %>%
  clean_names()
# Attention: TSV, not CSV
organizations_cordis_fp6 <-
  here("data-raw", "cordis-fp6organizations.csv") %>%
  read_tsv()
```

### Participation Details

Participation details are provided in the *organization* data tables.  To work with the latest CORDIS data, we load the previously unzipped CSV files:

```{r, load-organizations-cordis-data}
organizations_cordis_h2020 <-
  here("data-raw", "h2020", "csv", "organization.csv") %>%
  read_csv2(guess_max = 100000) %>%
  select(
    -contentUpdateDate,
    -SME,
    -nutsCode,
    -endOfParticipation,
    -active,
    -totalCost,
    -rcn
  )

organizations_cordis_fp7 <-
  here("data-raw", "fp7", "csv", "organization.csv") %>%
  read_csv2(guess_max = 130000) %>%
  select(
    -contentUpdateDate,
    -SME,
    -nutsCode,
    -endOfParticipation,
    -active,
    -totalCost,
    -rcn
  )

# Attention!
# 3 cases where (project_id, pic)
# appear 2x w/ different partner_role

organizations_cordis <-
  organizations_cordis_fp7 %>%
  bind_rows(organizations_cordis_h2020) %>%
  clean_names() %>%
  select(
    project_id,
    pic = organisation_id,
    legal_name = name,
    legal_short_name = short_name,
    legal_entity_type = activity_type,
    country_code = country,
    legal_url = organization_url,
    partner_role = role,
    ec_contribution,
    net_ec_contribution
  )
```

Unlike for the project details, Horizon Dashboard participation data is only available for H2020, not for FP7.  For H2020 projects, Horizon Dashboard participation data is more comprehensive than CORDIS data and is used as the source of EU official statistics.

```{r, load-organizations-dashboard-data}
organizations_dashboard_h2020 <-
  here("data-raw", "horizon2020.xlsx") %>%
  read_excel() %>%
  clean_names() %>%
  select(
    project_id = project_nbr,
    pic = general_pic,
    partner_role,
    pillar_abbr,
    pillar_descr,
    thematic_priority_abbr,
    signature_date,
    call_deadline_date,
    eu_contribution
  ) %>%
  mutate(partner_role = str_to_lower(partner_role))
```

Once again, we combine both datasets:

```{r, load-organizations-data}
organizations <-
  organizations_dashboard_h2020 %>%
  full_join(organizations_cordis,
    by = c("project_id", "pic", "partner_role")
  )
```

### Project and Participation Details Combined

Having combined both CORDIS and Horizon Dashboard datasets, we obtain three columns with contribution details: `ec_contribution` (CORDIS), `net_ec_contribution` (CORDIS), and `eu_contribution` (Horizon Dashboard). As the European Commission official reporting is based on `eu_contribution` from the Horizon Dashboard, we will check how the values from CORDIS -- `ec_contribution` and `net_ec_contribution` -- compare to `eu_contribution` under H2020.

```{r viz-contributions, eval=FALSE}
dfsample <- organizations %>%
  filter(!is.na(net_ec_contribution)) %>%
  sample_n(10000)
plot(
  dfsample$ec_contribution,
  dfsample$eu_contribution,
  type = "p",
  pch = 19,
  cex = .5,
  log = "xy"
)
plot(
  dfsample$net_ec_contribution,
  dfsample$eu_contribution,
  type = "p",
  pch = 19,
  cex = .5,
  log = "xy"
)
```


```{r}
# check differences
anti_join(organizations, projects, by = "project_id")
anti_join(projects, organizations, by = "project_id")

df_raw <- organizations %>%
  left_join(projects, by = "project_id")
```

Below, we add country names and perform minor cleaning of the data set.

```{r transform}
# download CORDIS country codes
country_codes <-
  "https://cordis.europa.eu/data/reference/cordisref-countries.csv" %>%
  read_csv2() %>%
  clean_names() %>%
  filter(language == "en") %>%
  distinct(eu_code, name) %>%
  rename(country_code = eu_code, country = name)

df_raw <- df_raw %>%
  mutate(
    legal_entity_type = str_sub(legal_entity_type, 1, 3),
    country_code = str_sub(country_code, 1, 2),
    # rename role
    partner_role = str_to_title(partner_role),
    pillar = str_extract(pillar_abbr, "\\d"),
    pillar = if_else(pillar_abbr == "EU.0.", "Cross-theme", pillar),
    pillar = if_else(pillar_abbr == "Euratom", pillar_abbr, pillar),
    # clean contributions
    ec_contribution = str_replace(ec_contribution, ",", "."),
    ec_contribution = str_replace(
      ec_contribution,
      fixed("xxxxx"),
      NA_character_
    ),
    eu_contribution = str_replace(eu_contribution, fixed("-"), "0"),
    ec_contribution = as.numeric(ec_contribution),
    net_ec_contribution = as.numeric(net_ec_contribution),
    eu_contribution = as.numeric(eu_contribution),
    # reconcile FP7 and H2020 contribution data
    re_contribution = eu_contribution,
    re_contribution = if_else(is.na(re_contribution),
      net_ec_contribution,
      re_contribution
    ),
    re_contribution = if_else(is.na(re_contribution),
      ec_contribution,
      re_contribution
    ),
    # country code
    country_code = str_replace(country_code, "KO", "XK"),
    # import dates
    signature_date = as.Date(signature_date, format = "%d/%m/%Y"),
    call_deadline_date = as.Date(call_deadline_date, format = "%d/%m/%Y"),
    signature_year = str_sub(signature_date, 1, 4),
    call_year = str_sub(call_deadline_date, 1, 4),
    start_year = str_sub(start_date, 1, 4),
    signature_year = int(signature_year),
    call_year = int(call_year),
    start_year = int(start_year)
  ) %>%
  left_join(country_codes, by = "country_code") %>%
  filter(!is.na(start_date))
```

Last, we write the view by year to the `./data` folder

```{r write, include=FALSE}
# store data types
df_schema <- df_raw %>%
  map_chr(class)

# split CSVs by year
df_years <-
  df_raw %>%
  distinct(start_year) %>%
  pull() %>%
  sort()
df_raw <- df_raw %>%
  arrange(start_year) %>%
  group_by(start_year) %>%
  group_split() %>%
  setNames(df_years)

# write to ./data
file_names <- here("data", glue("cordis-plus-{df_years}.csv"))
walk2(df_raw, file_names, vroom_write, delim = ",")
write_yaml(df_schema, here("data", "schema-cordis-plus.yml"))
```

